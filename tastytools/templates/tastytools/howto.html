{% extends "api_doc/base.html" %}
{% load staticlink %}

{% block extra_head %}
    {% staticlink js:tastytools/lib/SyntaxHighlighter/shCore.js %}
    {% staticlink js:tastytools/lib/SyntaxHighlighter/shBrushPython.js %}

    {% staticlink css:tastytools/lib/SyntaxHighlighter/shCore.css %}
    {% staticlink css:tastytools/lib/SyntaxHighlighter/shThemeDefault %}

    {% staticlink css:tastytools/api.howto %}

    <script type='text/javascript'>
        $(document).ready(function(){
            console.log("hola");
            SyntaxHighlighter.highlight()
        });
    </script>
{% endblock %}

{% block content %}
<div class='content'>
    <h1>TastyTools</h1>

    <h2>Registering Resources</h2>

    <p>File <strong>/api/application.py</strong></p>
    <pre class='brush: py'>
from tastytools.api import Api
from resources import CommentResource

class MessageBoardApi(Api):

    def __init__(self):
        resources = [CommentResource]
        api_name = 'resources'

        super(ApplicationApi, self).__init__(resources=resources,
            api_name=api_name)

api = MessageBoardApi()
    </pre>

    <h2>Adding Automatic tests</h2>
    <p>File <strong>/api/tests.py</strong></p>
    <pre class='brush: py'>
from tastytools.test.definitions import resources, fields
from api.application import api

ResourceTests = resources.generate(api)
ResourceFieldTests = fields.generate(api)
    </pre>


    <h2>Defining Test Data</h2>
    <pre class='brush: py'>
from tastytools.test.resources import ResourceTestData, Related, TestData

class CommentTestData(ResourceTestData):

    def __init__(self, api):
        ResourceTestData.__init__(self, api, 'comment')

    def sample_data(self, related=Related.Model, force=False):
        data = TestData(self.api, force, related)

        data.set('post', resource='post', force={'comments': []})
        data.set('author', resource='user')
        data.set('published', '2010-12-24T06:23:48')
        data.set('content', 'Lorem ipsum...')

        return data
    </pre>

    <h2>Avoiding extra data generation in circular references</h2>
    <p>Say that you are generating your tests data for your blog post model, you may
       want to generate some comments as well, so the test post won't look so lonely
       all by itself.<p>
    <p>But take a look at our sample data generator funcion for the comments. If you've
       been paying attention, you'll notice that it generates a parent post on its own,
       which will in turn call the posts' own data generator function, and create yet
       <strong>another</strong> post.

    <p>This circular dependency issue is easily resolved when creating comments, because
    the generated parent post is forced to be comment-less on creation, thus avoiding
    the comments' generator function to be called again.<p>

    <p>However, when creating the test post, it would need to pass itself as the parent
    for the newly created comments, which cannot be done since the actual model doesn't
    exist yet.</p>

    <p>To solve this, it suffices to specify the <strong>related_name</strong> parameter,
    which indicates the reverse relation between the two models. Any related resource
    set with this parameter will be created after the test resources has been saved,
    and its related attribute will be forced to be the current model being created.</p>

    <pre class='brush: py, highlight: [15]'>
from tastytools.test.resources import ResourceTestData, Related, TestData

class PostTestData(ResourceTestData):

    def __init__(self, api):
        ResourceTestData.__init__(self, api, 'post')

    def sample_data(self, related=Related.Model, force=False):
        data = TestData(self.api, force, related)

        data.set('title', 'The best day ever.')
        data.set('author', resource='user')
        data.set('published', '2010-12-24T06:23:48')
        data.set('content', 'Lorem ipsum...')
        data.set('comments', resource='comment', count=5, related_name='post')

        return data
    </pre>

    <h2>Defining resources</h2>
    <pre class='brush: py, highlight: [1, 26]'>
from tastytools.resources import ModelResource
from tastytools.authentication import AuthenticationByMethod

class CommentResource(ModelResource):

    post = fields.ForeignKey("api.resources.InstantResource",
        attribute="post", help_text="Instant this comment belongs to.",
        full=False)
    author = fields.ForeignKey("api.resources.UserResource",
        attribute="author", help_text="Author of the comment.",
        full=True)
    published = fields.DateField(attribute='published', readonly=True,
        help_text="Date of publication.")
    content = fields.CharField(attribute="content",
        help_text="The actual comment.")

    class Meta:
        resource_name = "comment"
        authorization = Authorization()

        #requires authentication on all methods except GET
        authentication = AuthenticationByMethod("GET")

        object_class = Comment
        queryset = Comment.objects.all()
        example_class = CommentTestData

        allowed_methods = ['get', 'post', 'put', 'patch']
        excludes = ['id']
    </pre>

    <h2>Setting up urls</h2>
    <p>File <strong>/api/urls.py</strong></p>
    <pre class='brush: py, highlight: [2]'>
from django.conf.urls.defaults import patterns, include, url
from api.application import api

urlpatterns = patterns('',
        (r'^api/doc/$', 'tastytools.api_doc.views.doc'),
        (r'^api/howto/$', 'tastytools.api_doc.views.howto'),
        (r'^api/', include(api.urls)),
)
    </pre>

</div>
{% endblock %}
